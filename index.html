<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>炊飯用水量計算ツール</title>
<style>
  html, body {
    touch-action: manipulation; /* ダブルタップズームを無効化、ピンチズームは維持 */
    font-size: 18px; /* ページ全体の最低文字サイズ */
  }

  body {
    font-family: 'Segoe UI', sans-serif;
    margin: 20px;
    background: #e8e6e1;
    color: #333;
    font-size: 18px;
  }

  h1 {
    font-size: 22px;
    margin-bottom: 10px;
  }
  h4 {
    font-size: 19px;
    margin-top: 20px;
  }

  /* ラベル・入力欄は縦並び・幅統一 */
  label {
    display: block;
    margin: 10px 0 4px 0;
    font-size: 18px;
  }

  input[type="number"],
  input[type="text"],
  select {
    width: 220px; /* 幅統一 */
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;
    font-size: 18px;
    display: block; /* 縦並び確保 */
    margin-bottom: 12px;
    background-color: #d0e7ff; /* 薄い青 */
  }

  /* ボタン共通 */
  button {
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    color: white;
    cursor: pointer;
    margin: 6px 6px 6px 0;
    font-size: 18px;
  }

  .btn-blue { background-color: #1976d2; }
  .btn-blue:hover { background-color: #1565c0; }

  .btn-green { background-color: #66bb6a; }
  .btn-green:hover { background-color: #57a05a; }

  .btn-red { background-color: #ef5350; }
  .btn-red:hover { background-color: #d84340; }

  /* 結果表示 */
  .result {
    margin-top: 15px;
    padding: 12px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
    font-size: 18px;
  }

  /* トースト通知 */
  #toast {
    visibility: hidden;
    min-width: 200px;
    margin-left: -100px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 10px;
    position: fixed;
    z-index: 9999;
    left: 50%;
    bottom: 30px;
    font-size: 16px;
    opacity: 0;
    transition: opacity 0.5s ease, bottom 0.5s ease;
  }
  #toast.show {
    visibility: visible;
    opacity: 1;
    bottom: 50px;
  }

  /* 結果行ごとの背景色 */
  .result-line {
    display: block;
    padding: 6px 8px;
    border-radius: 4px;
    margin-bottom: 4px;
    font-size: 18px;
  }
  .water-weight { background-color: #ffe4e1 }       /* 薄いピンク */
  .rice-plus-water { background-color: #ccffcc }    /* 薄い緑 */
  .total-weight { background-color: #e0ffff; }       /* 薄い水色 */
  .rice-go { background-color: #fffacd; }            /* 薄い黄色 */


</style>

</head>
<body>
<h1>炊飯用 水量計算ツール</h1>

<label>お米の重量 (g): <input type="number" id="riceWeight" min="0"></label>
<label>内釜の重量 (g): <input type="number" id="potWeight" min="0"></label>
<label>水比率 (例: 1.2 = 1.2倍): <input type="number" id="waterRatio" step="0.01"></label>


<div class="result" id="result"></div>
<div id="toast"></div>


<hr>
<h4>個別設定値管理</h4>
<p>読み込む個別設定値</p>
<select id="profileSelect"></select>
<label>個別設定値名: <input type="text" id="profileName" placeholder="例: 象印・柔らかめ"></label>
<button class="btn-blue" onclick="saveProfile()">個別設定値を保存</button>
<button class="btn-red" onclick="deleteProfile()">選択中の個別設定値を削除</button>

<hr>
<h4>設定値管理</h4>
<button class="btn-blue" onclick="exportProfiles()">設定値をダウンロード</button>
<input type="file" id="importFile" accept=".R_KUN_txt" style="display:none" onchange="importProfiles(event)">
<button class="btn-green" onclick="document.getElementById('importFile').click()">設定値を読み込み</button>

<hr>


<script>
/* --- ユーティリティ --- */
function round(v){ return Math.round(v); }

function showToast(message, color){
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.style.backgroundColor = color || '#333';
  toast.className = 'show';
  setTimeout(()=>{ toast.className = toast.className.replace('show',''); }, 2500);
}

/* --- 計算 --- */
function calculate(){
  const riceWeight = parseFloat(document.getElementById('riceWeight').value) || 0;
  const potWeight = parseFloat(document.getElementById('potWeight').value) || 0;
  const waterRatio = parseFloat(document.getElementById('waterRatio').value) || 1.2;

  const waterWeight = riceWeight * waterRatio;
  const ricePlusWater = riceWeight + waterWeight;
  const totalWeight = ricePlusWater + potWeight;
  const goCount = riceWeight / 150;

  const resultDiv = document.getElementById('result');
  resultDiv.innerHTML = `
    <strong>計算結果:</strong>
    <span class="result-line water-weight"   >水の量　　　　　　　　　　: ${Math.round(waterWeight)} g</span>
    <span class="result-line rice-plus-water">お米＋水の合計重量　　　　: ${Math.round(ricePlusWater)} g</span>
    <span class="result-line total-weight"   >お米＋水＋内釜の合計重量　: ${Math.round(totalWeight)} g</span>
    <span class="result-line rice-go"        >炊飯コースの目安　　　　　: 約 ${goCount.toFixed(1)} 合</span>
  `;
}


/* --- 入力リスナ設定 --- */
function addInputListeners(){
  ['riceWeight','potWeight','waterRatio'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener('input', calculate);
  });
  const pn = document.getElementById('profileName');
  if(pn) pn.addEventListener('input', ()=>{ /* 表示用要素がなければ何もしない */ });
}

/* --- プロファイル一覧の読み込み --- */
function loadProfileList(){
  const select = document.getElementById('profileSelect');
  select.innerHTML = '';
  const data = JSON.parse(localStorage.getItem('riceCalcProfiles') || '{}');

  // 空の選択肢（未選択）を追加しておくと挙動が判りやすい
  const emptyOpt = document.createElement('option');
  emptyOpt.value = '';
  emptyOpt.textContent = '--- 選択してください ---';
  select.appendChild(emptyOpt);

  for(const name in data){
    const option = document.createElement('option');
    option.value = name;
    option.textContent = name;
    select.appendChild(option);
  }

  // change イベントはここで一度だけ設定（重複防止）
  // removeEventListener を使うために先に無名関数ではなく定義済み関数を使う
  select.removeEventListener('change', profileSelectChangeHandler);
  select.addEventListener('change', profileSelectChangeHandler);

  // lastProfile があれば選択してすぐ反映（ロード直後など）
  const last = localStorage.getItem('lastProfileName');
  if(last && data[last]){
    select.value = last;
    // 明示的に読み込む（即反映）
    loadProfile(last);
  } else {
    // デフォルトで計算更新だけしておく
    calculate();
  }
}

function profileSelectChangeHandler(e){
  const selected = e.target.value;
  if(!selected){
    // 空選択（--- 選択してください ---）が選ばれた場合は何もしない
    return;
  }
  loadProfile(selected);
  showToast(`「${selected}」を適用しました。`, '#66bb6a');
}

/* --- プロファイルの保存/読み込み/削除 --- */
function saveProfile(){
  const name = document.getElementById('profileName').value.trim();
  if(!name){ alert('設定値名を入力してください。'); return; }

  const data = JSON.parse(localStorage.getItem('riceCalcProfiles') || '{}');
  if(data[name]){
    if(!confirm(`「${name}」は既に存在します。上書きしますか？`)){
      alert('保存をキャンセルしました。'); return;
    }
  }
  data[name] = {
    potWeight: document.getElementById('potWeight').value,
    waterRatio: document.getElementById('waterRatio').value
  };
  localStorage.setItem('riceCalcProfiles', JSON.stringify(data));
  localStorage.setItem('lastProfileName', name);
  loadProfileList(); // リスト再構築 -> 最後のプロファイル自動選択＆即反映される
  showToast(`「${name}」を保存しました。`, '#1976d2');
}

function loadProfile(name){
  const data = JSON.parse(localStorage.getItem('riceCalcProfiles') || '{}');
  const profileName = name || document.getElementById('profileSelect').value;
  if(!profileName || !data[profileName]) return;
  const profile = data[profileName];
  document.getElementById('potWeight').value = profile.potWeight || '';
  document.getElementById('waterRatio').value = profile.waterRatio || '';
  document.getElementById('profileName').value = profileName;
  localStorage.setItem('lastProfileName', profileName);
  calculate();
}

function deleteProfile(){
  const select = document.getElementById('profileSelect');
  const name = select.value;
  if(!name){ alert('削除する設定値を選択してください。'); return; }
  if(!confirm(`「${name}」を削除しますか？`)) return;
  const data = JSON.parse(localStorage.getItem('riceCalcProfiles') || '{}');
  delete data[name];
  localStorage.setItem('riceCalcProfiles', JSON.stringify(data));
  // 削除後は lastProfileName が削除された場合にクリアする
  const last = localStorage.getItem('lastProfileName');
  if(last === name) localStorage.removeItem('lastProfileName');
  loadProfileList(); // リスト再構築（自動で選択・反映される）
  showToast(`「${name}」を削除しました。`, '#ef5350');
}

/* --- エクスポート/インポート --- */
function exportProfiles(){
  const data = JSON.parse(localStorage.getItem('riceCalcProfiles') || '{}');
  let text = '';
  for(const name in data){
    const profile = data[name];
    text += `【${name}】\n`;
    text += `potWeight=${profile.potWeight}\n`;
    text += `waterRatio=${profile.waterRatio}\n\n`;
  }

  // 重要：iPhone / Android 両対応の MIME
  const blob = new Blob([text], { type: 'application/octet-stream' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = 'ご飯設定ファイル.R_KUN_txt';

  // スマホ対応のため一時的に DOM に追加
  document.body.appendChild(a);

  // クリック実行
  a.click();

  // 後処理
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}


function importProfiles(event){
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    try{
      const lines = e.target.result.split(/\r?\n/);
      const data = {};
      let currentName = '';
      for(const line of lines){
        if(line.startsWith('【') && line.endsWith('】')){
          currentName = line.slice(1, -1).trim();
          data[currentName] = {};
        } else if(line.includes('=') && currentName){
          const [key, value] = line.split('=');
          data[currentName][key.trim()] = value.trim();
        }
      }
      const existing = JSON.parse(localStorage.getItem('riceCalcProfiles') || '{}');
      const merged = { ...existing, ...data };
      localStorage.setItem('riceCalcProfiles', JSON.stringify(merged));
      loadProfileList();
      showToast('設定値を読み込みました。', '#66bb6a');
    } catch(err){
      alert('読み込みに失敗しました。形式を確認してください。');
    }
  };
  reader.readAsText(file);
}

/* --- 初期化 --- */
window.addEventListener('load', ()=>{
  addInputListeners();
  loadProfileList(); // ここで change ハンドラ登録＆ lastProfile があれば即反映される
  // 初回表示の計算呼び出しは loadProfileList の中で処理される
});
</script>


</body>
</html>

